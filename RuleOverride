/** 
 * Clash-Verge-Rev å…¨å±€æ‰©å±•è„šæœ¬ï¼ˆé€‚é…â€œHK-BEUPÂ® ISPâ€ä¸»é€‰æ‹©å™¨ + blackmatrix7 å¸¸ç”¨è§„åˆ™ + Loyalsoldier é€šç”¨è§„åˆ™ï¼‰
 * Version 1.3-adapt-merge-plus
 * å˜æ›´è¯´æ˜Žï¼ˆä»…æ–°å¢žï¼Œä¸æ”¹åŠ¨åŽŸæœ‰é€»è¾‘ï¼‰ï¼š
 * - å¢žåŠ  Loyalsoldier è§„åˆ™é›†ï¼ˆicloudã€appleã€googleã€tld-not-cnã€telegramcidrï¼‰ï¼Œè§„åˆ™æŒ‡æ´¾ä¿æŒä½ çŽ°æœ‰ç­–ç•¥æ„å›¾
 * - ä¿ç•™æ­¤å‰ blackmatrix7 å¸¸ç”¨æœåŠ¡é›†åˆï¼Œå…¨éƒ¨èµ° â€œHK-BEUPÂ® ISPâ€
 * - DNS å¢žå¼ºï¼šä¸º geosite:cn,private,apple é…ç½®å›½å†… DoHï¼Œå¹¿å‘Šé›†åˆç›´æŽ¥è¿”å›ž successï¼Œå‡å°‘æ±¡æŸ“ä¸Žæ³„éœ²
 */

// ===================================================================================
// 1. è‡ªå®šä¹‰è§„åˆ™å’Œè¿‡æ»¤èŠ‚ç‚¹ï¼ˆåŽŸæ ·ä¿ç•™ï¼‰
// ===================================================================================
const EXCLUDED_KEYWORDS = [
  'å®˜ç½‘', 'åˆ°æœŸ', 'æµé‡', 'å‰©ä½™', 'æ—¶é—´', 'é‡ç½®', 'è®¢é˜…', 'å¡é¡¿',
  'è·ç¦»ä¸‹æ¬¡é‡ç½®å‰©ä½™', 'å¥—é¤åˆ°æœŸ', 'å¯¼èˆª'
];

const CustomizationRule = [
  "DOMAIN-SUFFIX,jetbrains.ai,HK-BEUPÂ® ISP",
  "PROCESS-NAME,tailscaled,DIRECT",
  "PROCESS-NAME,tailscaled.exe,DIRECT",
  "DOMAIN-SUFFIX,mcdn.bilivideo.com,REJECT",
  "DOMAIN-SUFFIX,mcdn.bilivideo.cn,REJECT",
  "DOMAIN-SUFFIX,szbdyd.com,REJECT",
];

// ===================================================================================
// 2. è‡ªå®šä¹‰é“¾æŽ¥ä»£ç†è½åœ°èŠ‚ç‚¹ï¼ˆåŽŸæ ·ä¿ç•™ï¼‰
// ===================================================================================
const chainTransitName = "é“¾å¼ä¸­è½¬";
const chainLandingProxies = [
  // ç•™ç©ºå³ä¸å¯ç”¨é“¾å¼
];

// ===================================================================================
// 3. æœåŠ¡æ¨¡å—åŒ–é…ç½®åŒºï¼ˆåŽŸæ ·ä¿ç•™ï¼‰
// ===================================================================================
const ENABLED_SERVICES = {
  openai: {
    enabled: true,
    allowDirect: false,
    groupName: "ChatGPT",
    icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/chatgpt.svg",
    regions: ["US"],
    rule: {
      providerKey: "openai",
      url: "https://fastly.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/OpenAI/OpenAI.yaml"
    }
  },
  anthropic: {
    enabled: true,
    allowDirect: false,
    groupName: "Claude",
    icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/claude.svg",
    regions: ["US"],
    rule: {
      providerKey: "anthropic",
      url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/classical/anthropic.yaml"
    }
  },
  telegram: {
    enabled: true,
    allowDirect: false,
    groupName: "Telegram",
    icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/telegram.svg",
    regions: ["SG"],
    rule: {
      providerKey: "telegram",
      url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Telegram/Telegram.yaml",
      options: "no-resolve"
    }
  },
  github: {
    enabled: true,
    allowDirect: false,
    groupName: "Github",
    icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/github.svg",
    regions: ["HK"],
    rule: {
      providerKey: "github",
      url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/classical/github.yaml"
    }
  },
  google: {
    enabled: true,
    allowDirect: false,
    groupName: "Google",
    icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/google.svg",
    regions: ["US"],
    rule: {
      providerKey: "google",
      url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Google/Google.yaml"
    }
  },
  microsoft: {
    enabled: true,
    allowDirect: true,
    groupName: "MicroSoft",
    icon: "https://www.clashverge.dev/assets/icons/microsoft.svg",
    regions: [],
    rule: {
      providerKey: "microsoft",
      url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Microsoft/Microsoft.yaml"
    }
  },
  apple: {
    enabled: true,
    allowDirect: true,
    groupName: "Apple",
    icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/apple.svg",
    regions: [],
    rule: {
      providerKey: "apple",
      url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Apple/Apple_Classical.yaml"
    }
  },
  netflix: {
    enabled: true,
    allowDirect: false,
    groupName: "Netflix",
    icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/netflix.svg",
    regions: ["HK"],
    rule: {
      providerKey: "netflix",
      url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Netflix/Netflix_Classical.yaml"
    }
  }
};

// ===================================================================================
// 4. åŒºåŸŸæžšä¸¾ï¼ˆåŽŸæ ·ä¿ç•™ï¼‰
// ===================================================================================
const REGIONS = {
  HK: { name: "é¦™æ¸¯", regex: /é¦™æ¸¯|HK|Hong|ðŸ‡­ðŸ‡°/, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/hk.svg" },
  TW: { name: "å°æ¹¾", regex: /å°æ¹¾|TW|Taiwan|Wan|ðŸ‡¨ðŸ‡³|ðŸ‡¹ðŸ‡¼/, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/tw.svg" },
  SG: { name: "æ–°åŠ å¡", regex: /æ–°åŠ å¡|ç‹®åŸŽ|SG|Singapore|ðŸ‡¸ðŸ‡¬/, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/sg.svg" },
  JP: { name: "æ—¥æœ¬", regex: /æ—¥æœ¬|JP|Japan|ðŸ‡¯ðŸ‡µ/, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/jp.svg" },
  US: { name: "ç¾Žå›½", regex: /ç¾Žå›½|US|United States|America|ðŸ‡ºðŸ‡¸/, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/us.svg" },
};

// ===================================================================================
// 5. åº•å±‚é…ç½®ï¼ˆåŽŸæ ·ä¿ç•™ + æ–°å¢ž providers ä¸Ž rulesï¼‰
// ===================================================================================
const chainLandingName = "é“¾å¼è½åœ°";
const groupBaseOption = {
  interval: 0,
  timeout: 3000,
  url: "http://www.gstatic.com/generate_204",
  lazy: true,
  "max-failed-times": 3,
  hidden: false
};

const ruleProviderCommon = {
  type: "http",
  format: "yaml",
  interval: 86400
};

// ä½ åŽŸæœ‰çš„é™æ€ providersï¼ˆLoyalsoldier åŸºç¡€é›†ï¼‰
const staticRuleProviders = {
  reject:       { ...ruleProviderCommon, behavior: "domain",   url: "https://fastly.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/reject.txt", path: "./ruleset/loyalsoldier/reject.yaml" },
  proxy:        { ...ruleProviderCommon, behavior: "domain",   url: "https://fastly.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/proxy.txt", path: "./ruleset/loyalsoldier/proxy.yaml" },
  direct:       { ...ruleProviderCommon, behavior: "domain",   url: "https://fastly.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/direct.txt", path: "./ruleset/loyalsoldier/direct.yaml" },
  cncidr:       { ...ruleProviderCommon, behavior: "ipcidr",   url: "https://fastly.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/cncidr.txt", path: "./ruleset/loyalsoldier/cncidr.yaml" },
  lancidr:      { ...ruleProviderCommon, behavior: "ipcidr",   url: "https://fastly.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/lancidr.txt", path: "./ruleset/loyalsoldier/lancidr.yaml" },
  applications: { ...ruleProviderCommon, behavior: "classical",url: "https://fastly.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/applications.txt", path: "./ruleset/loyalsoldier/applications.yaml" },
  private:      { ...ruleProviderCommon, behavior: "domain",   url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/classical/private.yaml", path: "./ruleset/MetaCubeX/private.yaml" },
  gfw:          { ...ruleProviderCommon, behavior: "domain",   url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/classical/gfw.yaml", path: "./ruleset/MetaCubeX/gfw.yaml" },
};

// æ–°å¢žçš„ Loyalsoldier providersï¼ˆä»…æ–°å¢žï¼Œä¸æ”¹åŠ¨åŽŸæœ‰ï¼‰
const lsExtraProviders = {
  icloud:       { ...ruleProviderCommon, behavior: "domain",   url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/icloud.txt", path: "./ruleset/loyalsoldier/icloud.yaml" },
  applecn:      { ...ruleProviderCommon, behavior: "domain",   url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/apple.txt", path: "./ruleset/loyalsoldier/apple.yaml" },
  googled:      { ...ruleProviderCommon, behavior: "domain",   url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/google.txt", path: "./ruleset/loyalsoldier/google.yaml" },
  tld_not_cn:   { ...ruleProviderCommon, behavior: "domain",   url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/tld-not-cn.txt", path: "./ruleset/loyalsoldier/tld-not-cn.yaml" },
  telegramcidr: { ...ruleProviderCommon, behavior: "ipcidr",   url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/telegramcidr.txt", path: "./ruleset/loyalsoldier/telegramcidr.yaml" }
};

// blackmatrix7 å¸¸ç”¨æœåŠ¡ï¼ˆæ­¤å‰å·²åˆå¹¶ï¼Œä¿ç•™ï¼‰
const bmRuleProviders = {
  youtube:    { ...ruleProviderCommon, behavior: "classical", url: "https://raw.githubusercontent.com/xxxx/global.yaml/blackmatrix7/ios_rule_script/master/rule/Clash/YouTube/YouTube.yaml" },
  twitter:    { ...ruleProviderCommon, behavior: "classical", url: "https://raw.githubusercontent.com/xxxx/global.yaml/blackmatrix7/ios_rule_script/master/rule/Clash/Twitter/Twitter.yaml" },
  tiktok:     { ...ruleProviderCommon, behavior: "classical", url: "https://raw.githubusercontent.com/xxxx/global.yaml/blackmatrix7/ios_rule_script/master/rule/Clash/TikTok/TikTok.yaml" },
  discord:    { ...ruleProviderCommon, behavior: "classical", url: "https://raw.githubusercontent.com/xxxx/global.yaml/blackmatrix7/ios_rule_script/master/rule/Clash/Discord/Discord.yaml" },
  wikipedia:  { ...ruleProviderCommon, behavior: "classical", url: "https://raw.githubusercontent.com/xxxx/global.yaml/blackmatrix7/ios_rule_script/master/rule/Clash/Wikipedia/Wikipedia.yaml" },
  gitlab:     { ...ruleProviderCommon, behavior: "classical", url: "https://raw.githubusercontent.com/xxxx/global.yaml/blackmatrix7/ios_rule_script/master/rule/Clash/GitLab/GitLab.yaml" },
  cloudflare: { ...ruleProviderCommon, behavior: "classical", url: "https://raw.githubusercontent.com/xxxx/global.yaml/blackmatrix7/ios_rule_script/master/rule/Clash/Cloudflare/Cloudflare.yaml" },
  paypal:     { ...ruleProviderCommon, behavior: "classical", url: "https://raw.githubusercontent.com/xxxx/global.yaml/blackmatrix7/ios_rule_script/master/rule/Clash/PayPal/PayPal.yaml" },
  reddit:     { ...ruleProviderCommon, behavior: "classical", url: "https://raw.githubusercontent.com/xxxx/global.yaml/blackmatrix7/ios_rule_script/master/rule/Clash/Reddit/Reddit.yaml" },
  spotify:    { ...ruleProviderCommon, behavior: "classical", url: "https://raw.githubusercontent.com/xxxx/global.yaml/blackmatrix7/ios_rule_script/master/rule/Clash/Spotify/Spotify.yaml" },
  steam:      { ...ruleProviderCommon, behavior: "classical", url: "https://raw.githubusercontent.com/xxxx/global.yaml/blackmatrix7/ios_rule_script/master/rule/Clash/Steam/Steam.yaml" },
  epic:       { ...ruleProviderCommon, behavior: "classical", url: "https://raw.githubusercontent.com/xxxx/global.yaml/blackmatrix7/ios_rule_script/master/rule/Clash/Epic/Epic.yaml" },
  onedrive:   { ...ruleProviderCommon, behavior: "classical", url: "https://raw.githubusercontent.com/xxxx/global.yaml/blackmatrix7/ios_rule_script/master/rule/Clash/OneDrive/OneDrive.yaml" },
  dropbox:    { ...ruleProviderCommon, behavior: "classical", url: "https://raw.githubusercontent.com/xxxx/global.yaml/blackmatrix7/ios_rule_script/master/rule/Clash/Dropbox/Dropbox.yaml" }
};

// é¡¶éƒ¨ä¸Žåº•éƒ¨è§„åˆ™ï¼ˆåŽŸæ ·ä¿ç•™ï¼‰
const staticRules = {
  top: [
    ...CustomizationRule,
    "RULE-SET,applications,DIRECT",
    "RULE-SET,private,DIRECT",
    "RULE-SET,reject,å¹¿å‘Šè¿‡æ»¤"
  ],
  bottom: [
    "RULE-SET,proxy,HK-BEUPÂ® ISP",
    "RULE-SET,gfw,HK-BEUPÂ® ISP",
    "RULE-SET,direct,DIRECT,no-resolve",
    "RULE-SET,lancidr,DIRECT,no-resolve",
    "RULE-SET,cncidr,DIRECT,no-resolve",
    "GEOIP,LAN,DIRECT,no-resolve",
    "GEOIP,CN,DIRECT,no-resolve",
    "MATCH,æ¼ç½‘ä¹‹é±¼"
  ]
};

// ===================================================================================
// DNSï¼ˆå¯¹é½ä½ åŸºç¡€é…ç½®ï¼Œå¹¶è¿½åŠ  nameserver-policy ä¼˜åŒ–ï¼‰
// ===================================================================================
const domesticNameservers = ["223.5.5.5", "119.29.29.29", "114.114.114.114"];
const foreignNameservers  = ["1.1.1.1", "8.8.8.8", "8.8.4.4", "208.67.222.222", "9.9.9.9"];

const dnsConfig = {
  enable: true,
  listen: "0.0.0.0:1053", // è‹¥ä»…æœ¬æœºä½¿ç”¨ï¼Œå»ºè®®æ”¹ä¸º "127.0.0.1:1053"
  secret: "K!c*ow9!@BgS!6Kw9r",
  ipv6: false,
  "prefer-h3": true,
  "use-system-hosts": false,
  "cache-algorithm": "arc",
  "enhanced-mode": "fake-ip",
  "fake-ip-range": "198.18.0.1/16",
  "fake-ip-filter": [
    "+.lan",
    "+.local",
    "+.msftconnecttest.com",
    "+.msftncsi.com",
    "localhost.ptlogin2.qq.com",
    "localhost.sec.qq.com",
    "localhost.work.weixin.qq.com"
  ],
  "default-nameserver": [ ...domesticNameservers ],
  nameserver: [ ...domesticNameservers ],
  "proxy-server-nameserver": [ ...domesticNameservers ],
  "respect-rules": true,
  // è¿½åŠ ï¼šå¯¹ CN/ç§æœ‰/Apple çš„è§£æžæŒ‡å®šå›½å†… DoHï¼›å¹¿å‘Šé›†åˆè¿”å›ž success
  "nameserver-policy": {
    "geosite:cn,private,apple": [ "https://doh.pub/dns-query", "https://dns.alidns.com/dns-query" ],
    "geosite:category-ads-all": "rcode://success"
  }
};

// ===================================================================================
// å·¥å…·å‡½æ•°ï¼ˆåŽŸæ ·ä¿ç•™ï¼‰
// ===================================================================================
function getNodeNames(allProxyNames, regionKeys = []) {
  if (!regionKeys || regionKeys.length === 0) return allProxyNames;
  const matchedProxies = new Set();
  for (const key of regionKeys) {
    const region = REGIONS[key];
    if (region && region.regex) {
      allProxyNames.forEach(proxyName => {
        if (region.regex.test(proxyName)) matchedProxies.add(proxyName);
      });
    }
  }
  return Array.from(matchedProxies);
}

// ===================================================================================
// 6. ç¨‹åºä¸»å…¥å£ï¼ˆä¿æŒåŽŸé€»è¾‘ï¼Œä»…æ–°å¢ž providers åˆå¹¶ä¸Žè§„åˆ™æ’å…¥ï¼‰
// ===================================================================================
function main(config) {
  if ((config?.proxies?.length ?? 0) === 0 &&
      (typeof config?.["proxy-providers"] === "object" ? Object.keys(config["proxy-providers"]).length : 0) === 0) {
    throw new Error("é…ç½®æ–‡ä»¶ä¸­æœªæ‰¾åˆ°ä»»ä½•ä»£ç†");
  }

  const initialProxies = [ ...(config.proxies || []), ...chainLandingProxies ];
  config.proxies = initialProxies.filter(p =>
    !EXCLUDED_KEYWORDS.some(keyword => (p?.name || "").includes(keyword))
  );
  const allProxyNames = config.proxies.map(p => p.name);
  const chainProxiesName = chainLandingProxies.map(p => p.name);

  // æŒ‰åœ°åŒºç”Ÿæˆç»„ï¼ˆåŽŸé€»è¾‘ï¼‰
  const manualRegionGroups = [];
  const autoRegionGroups = [];
  Object.keys(REGIONS).forEach(key => {
    const nodesInRegion = getNodeNames(allProxyNames, [key]);
    if (nodesInRegion.length > 0) {
      manualRegionGroups.push({
        ...groupBaseOption,
        name: `${key}-æ‰‹åŠ¨é€‰æ‹©`,
        type: 'select',
        proxies: nodesInRegion,
        icon: REGIONS[key].icon
      });
      autoRegionGroups.push({
        ...groupBaseOption,
        name: `${key}-è‡ªåŠ¨é€‰æ‹©`,
        type: 'url-test',
        url: "http://www.gstatic.com/generate_204",
        interval: 600,
        tolerance: 100,
        proxies: nodesInRegion,
        hidden: true,
        icon: "https://github.com/clash-verge-rev/clash-verge-rev.github.io/blob/main/docs/assets/icons/adjust.svg"
      });
    }
  });
  const allManualRegionGroupNames = manualRegionGroups.map(g => g.name);
  const allAutoRegionGroupNames = autoRegionGroups.map(g => g.name);

  // åŠ¨æ€æœåŠ¡ç»„ä¸Ž providersï¼ˆåŽŸé€»è¾‘ï¼‰
  const dynamicServiceGroups = [];
  const dynamicRuleProviders = {};
  const dynamicRules = [];

  for (const serviceKey in ENABLED_SERVICES) {
    const service = ENABLED_SERVICES[serviceKey];
    if (!service.enabled) continue;

    const availableProxies = ["HK-BEUPÂ® ISP"];
    if (service.allowDirect) availableProxies.unshift("DIRECT");

    let hasSpecificRegions = service.regions && service.regions.length > 0;
    let optionsFound = false;

    if (hasSpecificRegions) {
      const regionalNodes = getNodeNames(allProxyNames, service.regions);
      service.regions.forEach(key => {
        if (allManualRegionGroupNames.includes(`${key}-æ‰‹åŠ¨é€‰æ‹©`)) {
          availableProxies.push(`${key}-æ‰‹åŠ¨é€‰æ‹©`);
          optionsFound = true;
        }
      });
      if (regionalNodes.length > 0) {
        availableProxies.push(...regionalNodes);
        optionsFound = true;
      }
      if (!optionsFound) hasSpecificRegions = false;
    }
    if (!hasSpecificRegions) {
      availableProxies.push("æ‰‹åŠ¨é€‰æ‹©", ...allProxyNames);
    }

    dynamicServiceGroups.push({
      ...groupBaseOption,
      name: service.groupName,
      type: 'select',
      proxies: [...new Set(availableProxies)],
      icon: service.icon
    });

    dynamicRuleProviders[service.rule.providerKey] = {
      ...ruleProviderCommon,
      behavior: 'classical',
      url: service.rule.url,
      path: `./ruleset/generated/${service.rule.providerKey}.yaml`
    };

    let ruleString = `RULE-SET,${service.rule.providerKey},${service.groupName}`;
    if (service.rule.options) ruleString += `,${service.rule.options}`;
    dynamicRules.push(ruleString);
  }

  // åŸºç¡€åˆ†æµç»„ï¼ˆåŽŸé€»è¾‘ï¼‰
  const nodeSelectionProxies = ["æ‰‹åŠ¨é€‰æ‹©", "å»¶è¿Ÿé€‰ä¼˜", "æ•…éšœè½¬ç§»"];
  if (chainLandingProxies && chainLandingProxies.length > 0) nodeSelectionProxies.push(chainLandingName);
  nodeSelectionProxies.push(...allManualRegionGroupNames);

  let baseProxyGroups = [
    { ...groupBaseOption, name: "HK-BEUPÂ® ISP", type: "select", proxies: nodeSelectionProxies, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/adjust.svg" },
    { ...groupBaseOption, name: "æ‰‹åŠ¨é€‰æ‹©", type: "select", proxies: allProxyNames, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/link.svg" },
    { ...groupBaseOption, name: "å»¶è¿Ÿé€‰ä¼˜", type: "url-test", tolerance: 100, interval: 600, proxies: allProxyNames, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/speed.svg" },
    { ...groupBaseOption, name: "æ•…éšœè½¬ç§»", type: "fallback", interval: 600, proxies: allProxyNames, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/ambulance.svg" },
    { ...groupBaseOption, name: "å¹¿å‘Šè¿‡æ»¤", type: "select", proxies: ["REJECT", "DIRECT"], icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/bug.svg" },
    { ...groupBaseOption, name: "æ¼ç½‘ä¹‹é±¼", type: "select", proxies: ["HK-BEUPÂ® ISP", "DIRECT", ...allAutoRegionGroupNames], icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/fish.svg" },
  ];
  if (chainLandingProxies && chainLandingProxies.length > 0) {
    baseProxyGroups.push(
      { ...groupBaseOption, name: chainLandingName, type: "select", proxies: chainProxiesName, icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/adjust.svg" },
      { ...groupBaseOption, name: chainTransitName, type: "select", proxies: allProxyNames.filter(p => !chainProxiesName.includes(p)), icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/adjust.svg" }
    );
  }

  // â€”â€” å†™å›žé…ç½®ï¼šåˆå¹¶å…¨éƒ¨ providersï¼ˆä»…æ–°å¢žï¼Œä¸è¦†ç›–åŽŸæœ‰ï¼‰â€”â€”
  config["proxy-groups"]   = [...baseProxyGroups, ...dynamicServiceGroups, ...manualRegionGroups, ...autoRegionGroups];
  config["rule-providers"] = { 
    ...staticRuleProviders, 
    ...dynamicRuleProviders, 
    ...lsExtraProviders,
    ...bmRuleProviders 
  };

  // â€”â€” blackmatrix7 æ–°å¢žè§„åˆ™ï¼ˆå…¨éƒ¨èµ° HK-BEUPÂ® ISPï¼‰ï¼Œä¿æŒåŽŸé¡ºåºæ’å…¥ â€”â€” 
  const bmRules = [
    "RULE-SET,youtube,HK-BEUPÂ® ISP",
    "RULE-SET,twitter,HK-BEUPÂ® ISP",
    "RULE-SET,tiktok,HK-BEUPÂ® ISP",
    "RULE-SET,discord,HK-BEUPÂ® ISP",
    "RULE-SET,wikipedia,HK-BEUPÂ® ISP",
    "RULE-SET,gitlab,HK-BEUPÂ® ISP",
    "RULE-SET,cloudflare,HK-BEUPÂ® ISP",
    "RULE-SET,paypal,HK-BEUPÂ® ISP",
    "RULE-SET,reddit,HK-BEUPÂ® ISP",
    "RULE-SET,spotify,HK-BEUPÂ® ISP",
    "RULE-SET,steam,HK-BEUPÂ® ISP",
    "RULE-SET,epic,HK-BEUPÂ® ISP",
    "RULE-SET,onedrive,HK-BEUPÂ® ISP",
    "RULE-SET,dropbox,HK-BEUPÂ® ISP"
  ];

  // â€”â€” Loyalsoldier æ–°å¢žè§„åˆ™ â€”â€” 
  // æŒ‰ä½ çš„åˆ†æµæ„å›¾ï¼šApple/iCloud ç›´è¿žï¼›google åˆ—è¡¨éµå¾ªä½ çŽ°æœ‰çš„ Google ç»„ï¼ˆè¯¥ç»„å·²èµ° HK-BEUPÂ® ISPï¼‰ï¼›
  // tld-not-cnã€telegramcidr èµ°ä¸»é€‰æ‹©å™¨ HK-BEUPÂ® ISPï¼ˆå¯ç”¨æ€§ä¼˜å…ˆï¼‰
  const lsRules = [
    "RULE-SET,icloud,DIRECT",
    "RULE-SET,applecn,DIRECT",
    "RULE-SET,googled,Google",         // ä½ çš„ Google ç»„å·²å­˜åœ¨ï¼Œä¿æŒé€»è¾‘ä¸€è‡´
    "RULE-SET,tld_not_cn,HK-BEUPÂ® ISP",
    "RULE-SET,telegramcidr,HK-BEUPÂ® ISP"
  ];

  // è§„åˆ™è£…é…ï¼šé¡¶ -> åŠ¨æ€æœåŠ¡ -> blackmatrix7 -> Loyalsoldier æ‰©å±• -> åº•
  config["rules"] = [
    ...staticRules.top,
    ...dynamicRules,
    ...bmRules,
    ...lsRules,
    ...staticRules.bottom
  ];

  // DNS
  config["dns"] = dnsConfig;

  // ç»Ÿä¸€å¼€å¯ UDP
  config["proxies"].forEach(proxy => { proxy.udp = true; });

  return config;
}
